<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Luke Guerdan | The Fittest Mario</title>
<meta name="description" content="An academic homepage with information about my projects, blog, and publications.
">

<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.17.0/css/mdb.min.css" integrity="sha256-/SwJ2GDcEt5382i8zqDwl36VJGECxEoIcBIuoLmLR4g=" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"  integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

<!-- Styles -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">
<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/projects/mario_ec/">

<!-- Open Graph -->


  </head>

  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light bg-white navbar-expand-sm fixed-top">
    <div class="container">
      
      
      
      
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       <span class="font-weight-bold">Luke</span>   Guerdan
      </a>
      
      <!-- Navbar Toogle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          <li class="nav-item">
            <a class="nav-link" href="/assets/pdf/LukeGuerdanCV.pdf" target="_">
              CV
            </a>
        </li>
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      <div class="post">

  <header class="post-header">
    <h1 class="post-title">The Fittest Mario</h1>
    <p class="post-description">An evolutionary computation approach to Super Mario Bros</p>
  </header>

  <article>
    <p>This project was a collaboration with <strong>Pooneh Safayenikoo</strong>, <strong>Pedro Carrion Castagnola</strong>, <strong>Marshall Lindsay</strong>, <strong>Jeffrey Ruffolo</strong> at the University of Missouri. My role involved developing a generic state representation and optimization framework for the game that could be extended via evolutionary computation techniques. My teammates ran experiments with with specific aspects of the solver, including the fitness function, parent selection, mutations, and crossover methods.</p>

<p>Here is a demo video I made about the system (animations courtesy of Jeffrey Ruffolo), tailored to high school science students.</p>

<figure>
    <iframe src="https://drive.google.com/file/d/1q3ZSv5JlkcVEg80W5McjOVl_FKM08goK/preview" width="110%" height="450px"></iframe>
</figure>

<p>Super Mario Bros is a classic platformer video game in which the player tries to navigate Mario to the flag at the end of the stage. During this time, the player must successfully overcome obstacles and terrains in order to progress. Our project implements an evolutionary computation approach to finding a sequence of player actions to beat the game. We experiment with several operators for parent selection, crossover, mutation, and fitness evaluation. Results show successful convergence towards winning action sequences, with convergence rate responding to changes in strategies. We also observed different gameplay behaviors for chromosomes evaluated using different fitness functions.</p>

<h1 id="chromosome-representation">Chromosome representation</h1>
<p>The chromosome is represented as a sequence of game actions taken by the player (such as up, left, or right), which when emulated result in a fitness score for the given chromosome. We also used the index of game over for crossover and mutation methods because after this index the actions do not influence on the fitness. The chromosome in our implementation is an object that contains: a list of action sequences (integers), fitness score and index of game over. Figure 1 shows a representation of the chromosome.</p>

<div class="row">
    <div class="col-sm mt-3 mt-md-0 margin-top center">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/ec1.png" alt="" />
    </div>
</div>
<div class="caption">
    Figure 1.
</div>

<h1 id="simulation-environment">Simulation environment</h1>
<p>We used gym-super-mario-bros, an <a href="https://gym.openai.com/">OpenAI Gym environment</a> for Super Mario Bros on The Nintendo Entertainment System (NES) using the <a href="https://github.com/Kautenja/gym-super-mario-bros">nes-py emulator</a>. This environment provides an easy-to-use, high-level API for making commands in Super Mario Bros. Figure 2 shows the general pipeline of our experiments.</p>

<div class="row">
    <div class="col-sm mt-2 mt-md-0 margin-top center">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/ec2.png" alt="" />
    </div>
</div>
<div class="caption">
    Figure 2.
</div>

<p>To implement this experiment pipeline, I made a simple boilerplate Python wrapper, <code class="language-plaintext highlighter-rouge">MSBGeneticOptimizerEnv</code>, that maintains the chomosome state and runs chromosome selection, crossover, and mutation:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">functools</span><span class="p">,</span> <span class="n">gym_super_mario_bros</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">csv</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">nes_py.wrappers</span> <span class="kn">import</span> <span class="n">BinarySpaceToDiscreteSpaceEnv</span>
<span class="kn">from</span> <span class="nn">gym_super_mario_bros.actions</span> <span class="kn">import</span> <span class="n">SIMPLE_MOVEMENT</span><span class="p">,</span> <span class="n">COMPLEX_MOVEMENT</span><span class="p">,</span> <span class="n">RIGHT_ONLY</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">try</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="n">pickle</span>
<span class="k">except</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">pickle</span>


<span class="c1">#MSBGeneticOptimizerEnv contains boilerplate code for the project
</span><span class="k">class</span> <span class="nc">MSBGeneticOptimizerEnv</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="s">"""An environment wrapper for genetically optimizing mario smash brothers simulation ."""</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">num_chromosomes</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">action_encoding</span><span class="o">=</span><span class="n">RIGHT_ONLY</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fitness_strategy</span><span class="o">=</span><span class="s">"x_pos"</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="s">""</span><span class="p">,</span> <span class="n">world</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">noFrameSkip</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">session_file</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">load_optimizer</span><span class="p">(</span><span class="n">session_file</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">max_steps</span> <span class="o">=</span> <span class="n">max_steps</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">action_encoding</span> <span class="o">=</span> <span class="n">action_encoding</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">render</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span> <span class="o">=</span> <span class="n">fitness_strategy</span>  <span class="c1">#score, x_pos, time, coins
</span>         <span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span> <span class="o">=</span> <span class="n">num_chromosomes</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">world</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">noFrameSkip</span> <span class="o">=</span> <span class="s">'NoFrameskip'</span> <span class="k">if</span> <span class="n">noFrameSkip</span> <span class="k">else</span> <span class="s">''</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">init_chromosomes</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">init_chromosomes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="s">"""Creates a new set of genes based on the number of parents fed in"""</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">):</span>
         <span class="n">chromosome</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">action_encoding</span><span class="p">),</span> <span class="bp">self</span><span class="p">.</span><span class="n">max_steps</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">chromosome</span><span class="p">)</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">evaluate_chromosomes</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">save_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
      <span class="k">print</span><span class="p">(</span><span class="s">"saving optimizer state to "</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
      <span class="n">optimizer_state</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">max_steps</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">action_encoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">stage</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">noFrameSkip</span><span class="p">)</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
         <span class="n">pickle</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">optimizer_state</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">load_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
      <span class="k">print</span><span class="p">(</span><span class="s">"loading optimier state from "</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
         <span class="n">optimizer</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">max_steps</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">max_steps</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">action_encoding</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">action_encoding</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">render</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">fitness_strategy</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">num_chromosomes</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">chromosomes</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">world</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">stage</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">version</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">noFrameSkip</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">noFrameSkip</span>


   <span class="k">def</span> <span class="nf">run_generations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngens</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>

      <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">'generation'</span><span class="p">,</span> <span class="s">'chromosome_num'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span><span class="p">,</span> <span class="s">'avg_fitness'</span><span class="p">]</span>

      <span class="c1">#If logging for the first time, set up csv file
</span>      <span class="k">if</span> <span class="n">fname</span><span class="p">:</span>
         <span class="k">print</span><span class="p">(</span><span class="s">"logging progress to "</span> <span class="o">+</span> <span class="n">fname</span><span class="p">)</span>

         <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">','</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">fieldnames</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">writeheader</span><span class="p">()</span>

      <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngens</span><span class="p">):</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">new_generation</span><span class="p">()</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">evaluate_chromosomes</span><span class="p">()</span>
         <span class="n">max_fitness</span><span class="p">,</span> <span class="n">max_fitness_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_max_fitness_chromosome</span><span class="p">()</span>
         <span class="n">avg_fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_avg_chromosome_fitness</span><span class="p">()</span>

         <span class="c1">#If writing progress to output, add this generation
</span>         <span class="k">if</span> <span class="n">fname</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
               <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">','</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">fieldnames</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
               <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">({</span><span class="s">'generation'</span><span class="p">:</span> <span class="n">gen</span><span class="p">,</span> <span class="s">'chromosome_num'</span><span class="p">:</span> <span class="n">max_fitness_ix</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span><span class="p">:</span> <span class="n">max_fitness</span><span class="p">,</span> <span class="s">'avg_fitness'</span><span class="p">:</span> <span class="n">avg_fitness</span><span class="p">})</span>

         <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">#################################"</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s">"GENERATION"</span><span class="p">,</span><span class="n">gen</span><span class="p">,</span><span class="s">"COMPLETE"</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s">"Highest chromosome: "</span><span class="p">,</span><span class="n">max_fitness_ix</span><span class="p">,</span><span class="s">", fitness:"</span><span class="p">,</span><span class="n">max_fitness</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s">"Average fitness: "</span><span class="p">,</span> <span class="n">avg_fitness</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s">"####################################</span><span class="se">\n\n\n</span><span class="s">"</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">get_max_fitness_chromosome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="s">"""returns highest fitness of current chromosomes, along with its index"""</span>
      <span class="n">max_fitness</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="n">max_fitness_ix</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="n">max_chromosome</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">cix</span><span class="p">,</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">chromosome</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_fitness</span><span class="p">:</span>
            <span class="n">max_fitness</span> <span class="o">=</span> <span class="n">chromosome</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">max_fitness_ix</span> <span class="o">=</span> <span class="n">cix</span>

      <span class="k">return</span> <span class="n">max_fitness</span><span class="p">,</span> <span class="n">max_fitness_ix</span>

   <span class="k">def</span> <span class="nf">get_avg_chromosome_fitness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">total_fitness</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">:</span>
         <span class="n">total_fitness</span> <span class="o">+=</span> <span class="n">chromosome</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_fitness</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">))</span>

   <span class="o">@</span><span class="n">abstractmethod</span>
   <span class="k">def</span> <span class="nf">new_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="s">"""
      Based on a chromosomes structure, updates the chromosomes by natural selection rules
      This is where the bulk of the evolutionary computation code will go
      Update here
      """</span>
      <span class="c1">#
</span>      <span class="k">pass</span>
      <span class="c1"># For now now selection occurs, just keep current chromosomes
</span>

   <span class="k">def</span> <span class="nf">run_top_chromosome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
      <span class="s">"""
      Retrieve the best-performing chromosome and play it.
      Override render argument in case only want to visualize on test round
      """</span>
      <span class="n">max_fitness</span><span class="p">,</span> <span class="n">max_fitness_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_max_fitness_chromosome</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">max_fitness</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
         <span class="k">print</span><span class="p">(</span><span class="s">'Run top chromosome error: no fitnesses have been computed'</span><span class="p">)</span>

      <span class="k">with</span> <span class="n">mariocontext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">env</span><span class="p">:</span>
         <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[</span><span class="n">max_fitness_ix</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">done</span> <span class="ow">or</span> <span class="n">info</span><span class="p">[</span><span class="s">'flag_get'</span><span class="p">]:</span>
               <span class="k">return</span>

            <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="n">env</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>


   <span class="k">def</span> <span class="nf">evaluate_chromosome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tuple</span><span class="p">):</span>
      <span class="s">"""Evaluates a chromosome for it's fitness value and index of death"""</span>

      <span class="n">chromosome_num</span><span class="p">,</span> <span class="n">chromosome</span> <span class="o">=</span> <span class="n">input_tuple</span>

      <span class="k">if</span> <span class="n">chromosome</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">chromosome</span>

      <span class="k">with</span> <span class="n">mariocontext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">env</span><span class="p">:</span>

         <span class="n">best_fitness_step</span> <span class="o">=</span> <span class="mi">0</span>

         <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>
         <span class="c1">#Main evaluation loop for this chromosome
</span>         <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chromosome</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="c1">#take step
</span>            <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_fitness_step</span><span class="p">):</span>
               <span class="n">best_fitness_step</span> <span class="o">=</span> <span class="n">step</span>

            <span class="c1">#died or level beat
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="ow">or</span> <span class="n">info</span><span class="p">[</span><span class="s">'flag_get'</span><span class="p">]):</span>
               <span class="k">break</span>

            <span class="c1">#print progress
</span>            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">print</span><span class="p">(</span><span class="s">"chromosome:"</span><span class="p">,</span><span class="n">chromosome_num</span><span class="p">,</span><span class="s">" step:"</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span><span class="s">" action:"</span><span class="p">,</span><span class="n">action</span><span class="p">,</span> <span class="s">"info:"</span><span class="p">,</span><span class="n">info</span><span class="p">)</span>

            <span class="c1">#display on screen
</span>            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">:</span>
               <span class="n">env</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>

         <span class="n">chromosome</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chromosome</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span><span class="p">],</span> <span class="n">best_fitness_step</span>

         <span class="k">print</span><span class="p">(</span><span class="s">"chromosome"</span><span class="p">,</span><span class="n">chromosome_num</span><span class="p">,</span><span class="s">" done fitness "</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span> <span class="p">,</span><span class="s">"= "</span><span class="p">,</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span><span class="p">])</span>
         <span class="k">return</span> <span class="n">chromosome</span>


   <span class="k">def</span> <span class="nf">evaluate_chromosomes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="s">"""
      Given a gene structure, evaluates all genes for their fitness and stores it in the stucture
      This is what actually runs the training simulation
      Input: a gene structure with (possibly) empty fitnesses
      Output: a gene structure with computed fitnesses and index of death
      """</span>

      <span class="n">bound_instance_method_alias</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_instance_method_alias</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
      <span class="k">with</span> <span class="n">poolcontext</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">bound_instance_method_alias</span><span class="p">,</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Optimizer</span><span class="p">():</span>
   <span class="s">"""A basic container class for saving optimizer contents"""</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">num_chromosomes</span><span class="p">,</span> <span class="n">action_encoding</span><span class="p">,</span> <span class="n">render</span><span class="p">,</span> <span class="n">fitness_strategy</span><span class="p">,</span> <span class="n">chromosomes</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">noFrameSkip</span><span class="p">):</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">max_steps</span> <span class="o">=</span> <span class="n">max_steps</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span> <span class="o">=</span> <span class="n">num_chromosomes</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">action_encoding</span> <span class="o">=</span> <span class="n">action_encoding</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">render</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">fitness_strategy</span> <span class="o">=</span> <span class="n">fitness_strategy</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span> <span class="o">=</span> <span class="n">chromosomes</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">world</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">noFrameSkip</span> <span class="o">=</span> <span class="n">noFrameSkip</span>


<span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">poolcontext</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
   <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="n">Pool</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
   <span class="k">yield</span> <span class="n">pool</span>
   <span class="n">pool</span><span class="p">.</span><span class="n">terminate</span><span class="p">()</span>

<span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">mariocontext</span><span class="p">(</span><span class="n">marioEnv</span><span class="p">):</span>
   <span class="n">mario_env</span> <span class="o">=</span> <span class="s">'SuperMarioBros'</span> <span class="o">+</span> <span class="n">marioEnv</span><span class="p">.</span><span class="n">noFrameSkip</span> <span class="o">+</span> <span class="s">'-'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">marioEnv</span><span class="p">.</span><span class="n">world</span><span class="p">)</span> <span class="o">+</span> <span class="s">'-'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">marioEnv</span><span class="p">.</span><span class="n">stage</span><span class="p">)</span> <span class="o">+</span> <span class="s">'-v'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">marioEnv</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>
   <span class="n">env</span> <span class="o">=</span> <span class="n">gym_super_mario_bros</span><span class="p">.</span><span class="n">make</span><span class="p">(</span><span class="n">mario_env</span><span class="p">)</span>
   <span class="n">env</span> <span class="o">=</span> <span class="n">BinarySpaceToDiscreteSpaceEnv</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">marioEnv</span><span class="p">.</span><span class="n">action_encoding</span><span class="p">)</span>
   <span class="k">yield</span> <span class="n">env</span>
   <span class="n">env</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_instance_method_alias</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
   <span class="s">"""
   Alias for instance method that allows the method to be called in a
   multiprocessing pool
   """</span>
   <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="n">evaluate_chromosome</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This environment can be easily extended to customize crossover, parent selection, and mutation methods. Here is an example of an <code class="language-plaintext highlighter-rouge">EvolutionEnv</code> extending the <code class="language-plaintext highlighter-rouge">MSBGeneticOptimizerEnv</code>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">msb_genetic_optimizer_env</span> <span class="kn">import</span> <span class="n">MSBGeneticOptimizerEnv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>


<span class="c1">##The below class inherits everything from MSBGeneticOptimizerEnv, all you will need to do is modi
</span><span class="k">class</span> <span class="nc">EvolutionEnv</span><span class="p">(</span><span class="n">MSBGeneticOptimizerEnv</span><span class="p">):</span>
   <span class="c1"># Arguments: max_steps=10000, num_chromosomes=4, action_encoding=SIMPLE_MOVEMENT, render=False, reward="score", session_file=""
</span>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">EvolutionEnv</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">new_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="s">"""
      Based on a chromosomes structure, updates the chromosomes by natural selection rules
      This is where the bulk of the evolutionary computation code will go
      We will need to modify the chromosome structure in some
      """</span>
        
      <span class="c1"># elite selection for parent
</span>      <span class="n">parents</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">select_parents</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
      <span class="n">offspring</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="c1"># Crossover
</span>      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))):</span>
         <span class="n">offspring</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">crossover_chromosome_pair</span><span class="p">(</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">parents</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="n">point_num</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">points_before_death</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normal_dist</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

      <span class="c1"># Mutation
</span>      <span class="c1"># using lambda = mu (numberof parents equal to the number of offsprings)
</span>      <span class="c1"># For each selected parent, will mutate around 20% of the max_steps actions
</span>      <span class="n">mutations</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">max_steps</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
         <span class="n">child</span> <span class="o">=</span> <span class="p">[</span><span class="n">chromosome</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">copy</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">mutate_chromosome</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">mutations</span><span class="p">)</span>
         <span class="n">offspring</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

      <span class="c1"># (mu, lambda) Using only offspring to populate new generation here
</span>      <span class="c1"># self.chromosomes = offspring
</span>
      <span class="c1"># (mu + lambda) Using parents + offspring to populate new generation here
</span>      <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span> <span class="o">=</span> <span class="n">parents</span> <span class="o">+</span> <span class="n">offspring</span>

   <span class="c1">###
</span>   <span class="c1">#  Basic implementation of parent selection
</span>   <span class="c1">#  - selection_type: 0: shuffle, 1: elite
</span>   <span class="c1">#  - mu: number of parents to select
</span>   <span class="c1">###
</span>   <span class="k">def</span> <span class="nf">select_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">shuffle_selection</span><span class="p">():</span>
         <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">)</span>
         <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[:</span><span class="n">mu</span><span class="p">]</span>

      <span class="k">def</span> <span class="nf">elite_selection</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
         <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="c1"># select mu best chromosomes
</span>         <span class="n">best_chromosomes_index</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                         <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
         <span class="c1"># delete from chromosome list if it is not within the mu best
</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
            <span class="n">parents</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[</span><span class="n">best_chromosomes_index</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
         <span class="k">return</span> <span class="n">parents</span>

      <span class="k">def</span> <span class="nf">linear_ranking_selection</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
         <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="n">best_chromosomes_index</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
         <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="n">s</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">):</span>
            <span class="n">s</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="p">((</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">-</span><span class="p">((</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)))))</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
            <span class="n">r</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">random_sample</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">):</span>
               <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                  <span class="n">parents</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[</span><span class="n">best_chromosomes_index</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]])</span>
         <span class="k">return</span> <span class="n">parents</span>

      <span class="k">def</span> <span class="nf">roulette_wheel_selection</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
         <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="n">total</span><span class="o">=</span><span class="mi">0</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">):</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="o">+</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
         <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="n">s</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">):</span>
            <span class="n">s</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="nb">float</span><span class="p">)(</span><span class="n">total</span><span class="p">)))</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
            <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">random_sample</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">num_chromosomes</span><span class="p">):</span>
               <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                  <span class="n">parents</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">chromosomes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">return</span> <span class="n">parents</span>

      <span class="k">if</span> <span class="n">selection_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">shuffle_selection</span><span class="p">()</span>
      <span class="k">elif</span> <span class="n">selection_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">elite_selection</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">selection_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">linear_ranking_selection</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">selection_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">roulette_wheel_selection</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">crossover_chromosome_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent1</span><span class="p">,</span> <span class="n">parent2</span><span class="p">,</span> <span class="n">point_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">points_before_death</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">normal_dist</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
      <span class="c1">###
</span>      <span class="c1">#	Implementation of crossover functionality
</span>      <span class="c1">#	- points: number of points to use in crossover
</span>      <span class="c1">#	- points_before_death: only consider points upto sooner death
</span>      <span class="c1">#	- normal_dist: sample crossover points from normal distribution
</span>      <span class="c1">###
</span>      <span class="k">def</span> <span class="nf">positive_normal</span><span class="p">():</span>
         <span class="n">x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randn</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
         <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

      <span class="n">point_range_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parent1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">points_before_death</span> \
         <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">parent1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">parent2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">random</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">rand</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">normal_dist</span> <span class="k">else</span> <span class="n">positive_normal</span>

      <span class="n">crossover_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_range_max</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">point_num</span><span class="p">):</span>
         <span class="n">crossover_points</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">point_range_max</span> <span class="o">*</span> <span class="n">random</span><span class="p">())))</span>
      <span class="n">crossover_points</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

      <span class="n">child1</span><span class="p">,</span> <span class="n">child2</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent1</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">copy</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">parent2</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">copy</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">crossover_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
         <span class="n">point1</span> <span class="o">=</span> <span class="n">crossover_points</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
         <span class="n">point2</span> <span class="o">=</span> <span class="n">crossover_points</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
         <span class="n">child1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">point1</span><span class="p">:</span><span class="n">point2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">point1</span><span class="p">:</span><span class="n">point2</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>
         <span class="n">child2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">point1</span><span class="p">:</span><span class="n">point2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">point1</span><span class="p">:</span><span class="n">point2</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>

      <span class="k">return</span> <span class="p">[</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">]</span>

   <span class="k">def</span> <span class="nf">mutate_chromosome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">mutations</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
   <span class="c1">###
</span>   <span class="c1"># Implementation of mutation operator
</span>   <span class="c1"># Mutations: number of mutations to make
</span>   <span class="c1">###
</span>      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mutations</span><span class="p">)):</span>
         <span class="c1">#mutation index: triangular distribution with: bound left=0, bound right and mode=index of game over
</span>         <span class="n">mutation_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">triangular</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chromosome</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
         <span class="c1">#new_action: random within the allowed possible actions
</span>         <span class="n">actions_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">action_encoding</span><span class="p">)</span>
         <span class="c1">#new_action = np.random.randint(low=0, high=actions_size)
</span>         <span class="c1">#new: prioritize actions between 1 to 4 (going right)
</span>         <span class="n">new_action</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="p">(</span><span class="n">actions_size</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">new_action</span> <span class="o">&gt;=</span> <span class="n">actions_size</span><span class="p">):</span>
            <span class="n">new_action</span> <span class="o">=</span> <span class="n">new_action</span> <span class="o">-</span> <span class="n">actions_size</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="n">chromosome</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mutation_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_action</span>
      <span class="n">chromosome</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chromosome</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>After this high-level wrapper is complete, it can easily be used in a short script. Here is an example experiment:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="c1">#create a new optimizer environment and initialize data structure
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">SelectionEnv</span><span class="p">(</span><span class="n">max_steps</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">num_chromosomes</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1">#run the optimizer for the desired number of generations
</span><span class="n">optimizer</span><span class="p">.</span><span class="n">run_generations</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1">#serialize the data structure to a file. Pickle for effeciency 
</span><span class="n">optimizer</span><span class="p">.</span><span class="n">save_optimizer</span><span class="p">(</span><span class="s">'mario-4-chromosome.p'</span><span class="p">)</span>

<span class="c1">#see how the top performing chromosome looks in the simulator 
</span><span class="n">optimizer</span><span class="p">.</span><span class="n">run_top_chromosome</span><span class="p">(</span><span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1">#To load a previous environment, either create a new optimizer with the filename,or call the load optimizer function directly. Note this will overwrite the current state
</span><span class="n">optimizer2</span> <span class="o">=</span> <span class="n">SelectionEnv</span><span class="p">(</span><span class="n">session_file</span> <span class="o">=</span><span class="s">"mario-4-chromosome.p"</span><span class="p">)</span>
<span class="n">load</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">session</span> <span class="ow">and</span> <span class="n">keep</span> <span class="n">training</span>
<span class="n">optimizer2</span><span class="p">.</span><span class="n">run_generations</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">optimizer2</span><span class="p">.</span><span class="n">save_optimizer</span><span class="p">(</span><span class="s">'mario-4-chromosome2.p'</span><span class="p">)</span> <span class="c1">#save to an updated file </span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>My teammates then extended this environment to examine different evolutionary computation simulations. See our <a href="/assets/pdf/mario-ec-2018-poster.pdf" target="_blank">poster here</a> for more information about these aspects of the project!</p>


  </article>

</div>

    </div>

    <!-- Footer -->

    
<footer class="sticky-bottom mt-5">
  <div class="container">
    &copy; Copyright 2020 Luke Guerdan.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
    Last updated: November 09, 2020.
    
  </div>
</footer>



  </body>

  <!-- Load Core and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.0/umd/popper.min.js" integrity="sha256-OH05DFHUWzr725HmuHo3pnuvUUn+TJuj8/Qz9xytFEw=" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.17.0/js/mdb.min.js"  integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />


<!-- Load KaTeX -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" integrity="sha256-V8SV2MO1FUb63Bwht5Wx9x6PVHNa02gv8BgH/uH3ung=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js" integrity="sha256-F/Xda58SPdcUCr+xhSGz9MA2zQBPb0ASEYKohl8UCHc=" crossorigin="anonymous"></script>
<script src="/assets/js/katex.js"></script>



<!-- Load Mansory & imagesLoaded -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js" integrity="" crossorigin="anonymous"></script>
<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>

<!-- Project Cards Layout -->
<script type="text/javascript">
  // Init Masonry
  var $grid = $('.grid').masonry({
    gutter: 10,
    horizontalOrder: true,
    itemSelector: '.grid-item',
  });
  // layout Masonry after each image loads
  $grid.imagesLoaded().progress( function() {
    $grid.masonry('layout');
  });
</script>







</html>
